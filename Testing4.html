<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U8 ç›´æ’­æºæª¢æ¸¬èˆ‡ç¯©é¸å·¥å…· Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; padding-bottom: 50px; }
        .status-badge { width: 80px; text-align: center; }
        .url-text { font-size: 0.85em; color: #666; max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; vertical-align: middle;}
        #videoModal .modal-body { padding: 0; background: black; }
        video { width: 100%; height: auto; display: block; max-height: 80vh; }
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; }
    </style>
</head>
<body>

<div id="loadingOverlay" class="loading-overlay d-none">
    <div class="spinner-border text-primary me-2" role="status"></div>
    <span id="loadingText">è™•ç†ä¸­...</span>
</div>

<div class="container mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-11">
            <h2 class="text-center mb-4">ğŸ“º M3U8 ç›´æ’­æºæª¢æ¸¬èˆ‡ç¯©é¸å·¥å…· Pro</h2>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">ğŸ“¥ ä¾†æºè¼¸å…¥</h5>
                </div>
                <div class="card-body">
                    <label class="form-label fw-bold">æ–¹å¼ Aï¼šå¾ç¶²å€è¼‰å…¥</label>
                    <div class="input-group mb-3">
                        <span class="input-group-text">ğŸ”— URL</span>
                        <input type="text" id="remoteUrlInput" class="form-control" placeholder="ä¾‹å¦‚ï¼šhttps://raw.githubusercontent.com/.../list.m3u">
                        <button class="btn btn-info text-white" onclick="loadFromUrl()">â¬‡ï¸ è¼‰å…¥å…§å®¹</button>
                    </div>

                    <hr class="my-3">

                    <label class="form-label fw-bold">æ–¹å¼ Bï¼šè²¼ä¸Šå…§å®¹ æˆ– ä¸Šå‚³æ–‡ä»¶</label>
                    <textarea id="m3uInput" class="form-control mb-3" rows="5" placeholder="#EXTM3U&#10;#EXTINF:-1,CCTV-1&#10;http://example.com/live.m3u8"></textarea>
                    
                    <div class="row g-2">
                        <div class="col-md-5">
                            <input type="file" id="fileInput" class="form-control" accept=".m3u,.m3u8,.txt">
                        </div>
                        <div class="col-md-7 text-end">
                            <button class="btn btn-secondary me-1" onclick="clearAll()">ğŸ§¹ æ¸…é™¤é‡ç½®</button>
                            <button class="btn btn-primary px-4" onclick="processM3U()">ğŸš€ è§£æä¸¦é–‹å§‹æª¢æ¸¬</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="actionPanel" class="d-none">
                <div class="alert alert-secondary d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div id="statsInfo">
                        ç¸½æ•¸: <strong id="totalCount">0</strong> | 
                        <span class="text-success">å¯ç”¨: <strong id="successCount">0</strong></span> | 
                        <span class="text-danger">å¤±æ•—: <strong id="failCount">0</strong></span>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-success btn-sm" onclick="downloadValidM3U()">ğŸ“¥ ä¸‹è¼‰å¯ç”¨æ¸…å–®</button>
                        <button class="btn btn-outline-dark btn-sm" onclick="copyValidUrls()">ğŸ“‹ è¤‡è£½é€£çµ</button>
                    </div>
                </div>
                <div class="progress mb-3" style="height: 20px;">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                    <span>æª¢æ¸¬çµæœåˆ—è¡¨</span>
                    <button id="filterBtn" class="btn btn-outline-primary btn-sm" onclick="toggleFilter()">
                        ğŸ‘ï¸ åªé¡¯ç¤ºå¯ç”¨é »é“
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>é »é“åç¨±</th>
                                    <th>é€£çµ / ç‹€æ…‹</th>
                                    <th style="width: 160px;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="resultBody">
                                <tr>
                                    <td colspan="4" class="text-center py-5 text-muted">
                                        è«‹è¼¸å…¥ç›´æ’­æºä¸¦æŒ‰ä¸‹é–‹å§‹æŒ‰éˆ•
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-truncate" id="modalTitle">æ’­æ”¾æ¸¬è©¦</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="stopVideo()"></button>
            </div>
            <div class="modal-body">
                <video id="videoPlayer" controls></video>
            </div>
            <div class="modal-footer justify-content-between">
                <small class="text-muted">è‹¥ç•«é¢é»‘å±ä½†æœ‰è²éŸ³æˆ–é€²åº¦æ¢ï¼Œä»£è¡¨æºæœ‰æ•ˆã€‚</small>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal" onclick="stopVideo()">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>

<script>
    let channels = [];
    let processing = false;
    let abortController = null;
    let isFiltered = false; // è¿½è¹¤ç›®å‰æ˜¯å¦è™•æ–¼ç¯©é¸ç‹€æ…‹

    // --- ç¯©é¸æŒ‰éˆ•é‚è¼¯ (æ–°å¢) ---
    function toggleFilter() {
        const btn = document.getElementById('filterBtn');
        isFiltered = !isFiltered; // åˆ‡æ›ç‹€æ…‹

        if (isFiltered) {
            // åˆ‡æ›ç‚ºï¼šåªé¡¯ç¤ºå¯ç”¨
            btn.innerHTML = 'ğŸ“‹ é¡¯ç¤ºå…¨éƒ¨é »é“';
            btn.classList.replace('btn-outline-primary', 'btn-primary');
            
            // éæ­·æ‰€æœ‰è¡Œï¼Œéš±è—é success çš„è¡Œ
            channels.forEach((ch, index) => {
                const row = document.getElementById(`row-${index}`);
                if (row) {
                    if (ch.status === 'success') {
                        row.style.display = ''; // é¡¯ç¤º
                    } else {
                        row.style.display = 'none'; // éš±è—
                    }
                }
            });

            // å¦‚æœæ²’æœ‰å¯ç”¨é »é“ï¼Œæç¤ºä¸€ä¸‹
            const successCount = channels.filter(c => c.status === 'success').length;
            if (successCount === 0) {
                alert('ç›®å‰æ²’æœ‰æª¢æ¸¬åˆ°ã€Œå¯ç”¨ã€çš„é »é“ï¼Œåˆ—è¡¨å·²æ¸…ç©ºé¡¯ç¤ºã€‚');
            }

        } else {
            // åˆ‡æ›ç‚ºï¼šé¡¯ç¤ºå…¨éƒ¨
            btn.innerHTML = 'ğŸ‘ï¸ åªé¡¯ç¤ºå¯ç”¨é »é“';
            btn.classList.replace('btn-primary', 'btn-outline-primary');

            // é¡¯ç¤ºæ‰€æœ‰è¡Œ
            const rows = document.querySelectorAll('#resultBody tr');
            rows.forEach(row => row.style.display = '');
        }
    }

    // --- å…¶ä»–åŸæœ‰åŠŸèƒ½ ---

    async function loadFromUrl() {
        const url = document.getElementById('remoteUrlInput').value.trim();
        if (!url) { alert('è«‹è¼¸å…¥ç¶²å€'); return; }

        showLoading(true, 'æ­£åœ¨ä¸‹è¼‰é ç«¯æ–‡ä»¶...');
        try {
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
            const response = await fetch(proxyUrl);
            if (!response.ok) throw new Error('ç¶²çµ¡è«‹æ±‚å¤±æ•—');
            
            const text = await response.text();
            document.getElementById('m3uInput').value = text;
            showLoading(false);
            
            setTimeout(() => {
                if(confirm('è¼‰å…¥æˆåŠŸï¼æ˜¯å¦ç«‹å³é–‹å§‹è§£æèˆ‡æª¢æ¸¬ï¼Ÿ')) {
                    processM3U();
                }
            }, 100);
        } catch (error) {
            showLoading(false);
            alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        }
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('m3uInput').value = e.target.result;
        };
        reader.readAsText(file);
    });

    function processM3U() {
        if (processing) return;
        if (abortController) abortController.abort();
        abortController = new AbortController();

        // é‡ç½®ç¯©é¸ç‹€æ…‹
        isFiltered = false;
        const filterBtn = document.getElementById('filterBtn');
        filterBtn.innerHTML = 'ğŸ‘ï¸ åªé¡¯ç¤ºå¯ç”¨é »é“';
        filterBtn.classList.replace('btn-primary', 'btn-outline-primary');

        const content = document.getElementById('m3uInput').value;
        if (!content.trim()) { alert('è«‹è¼¸å…¥å…§å®¹'); return; }

        const lines = content.split('\n');
        channels = [];
        let currentName = "æœªå‘½åé »é“";
        
        for (let line of lines) {
            line = line.trim();
            if (line.startsWith('#EXTINF')) {
                const parts = line.split(',');
                currentName = parts.length > 1 ? parts[parts.length - 1].trim() : "æœªçŸ¥é »é“";
            } else if (line.startsWith('http') || (line.endsWith('.m3u8') && !line.startsWith('#'))) {
                channels.push({
                    id: channels.length,
                    name: currentName,
                    url: line,
                    status: 'pending'
                });
                currentName = "æœªå‘½åé »é“"; 
            }
        }

        if (channels.length === 0) { alert('ç„¡æœ‰æ•ˆé€£çµ'); return; }

        document.getElementById('actionPanel').classList.remove('d-none');
        renderTable();
        startChecking();
    }

    function renderTable() {
        const tbody = document.getElementById('resultBody');
        tbody.innerHTML = '';
        updateStats();

        const fragment = document.createDocumentFragment();
        channels.forEach((ch, index) => {
            const tr = document.createElement('tr');
            tr.id = `row-${index}`;
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td class="fw-bold text-primary text-truncate" style="max-width: 200px;">${ch.name}</td>
                <td>
                    <span id="badge-${index}" class="badge bg-secondary status-badge me-2">å¾…æª¢æ¸¬</span>
                    <span class="url-text" title="${ch.url}">${ch.url}</span>
                </td>
                <td>
                    <button class="btn btn-sm btn-success mb-1" onclick="playChannel(${index})">â–¶ æ’­æ”¾</button>
                    <a href="${ch.url}" target="_blank" class="btn btn-sm btn-outline-secondary mb-1">ğŸ”— ç›´é€£</a>
                </td>
            `;
            fragment.appendChild(tr);
        });
        tbody.appendChild(fragment);
    }

    async function startChecking() {
        processing = true;
        const batchSize = 10;
        let completed = 0;
        updateProgressBar(0);

        for (let i = 0; i < channels.length; i += batchSize) {
            if (!processing) break;
            const batch = channels.slice(i, i + batchSize);
            await Promise.all(batch.map(ch => checkUrl(ch)));
            completed += batch.length;
            updateStats();
            updateProgressBar(Math.round((completed / channels.length) * 100));
            
            // å¦‚æœåœ¨æª¢æ¸¬éç¨‹ä¸­é–‹å•Ÿäº†ç¯©é¸ï¼Œå¯¦æ™‚æ›´æ–°é¡¯ç¤º
            if(isFiltered) {
                batch.forEach(ch => {
                    const row = document.getElementById(`row-${ch.id}`);
                    if(row && ch.status !== 'success') row.style.display = 'none';
                });
            }
        }
        processing = false;
    }

    async function checkUrl(channel) {
        const badge = document.getElementById(`badge-${channel.id}`);
        if(!badge) return;
        badge.className = 'badge bg-warning text-dark status-badge me-2';
        badge.innerText = '...';

        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 6000);
            const response = await fetch(channel.url, {
                method: 'GET',
                signal: controller.signal,
                referrerPolicy: 'no-referrer'
            });
            clearTimeout(timeoutId);

            if (response.ok) {
                channel.status = 'success';
                badge.className = 'badge bg-success status-badge me-2';
                badge.innerText = 'å¯ç”¨';
            } else {
                throw new Error('Status: ' + response.status);
            }
        } catch (error) {
            channel.status = 'fail';
            badge.className = 'badge bg-danger status-badge me-2';
            badge.innerText = 'å¤±æ•—';
        }
    }

    function downloadValidM3U() {
        const validList = channels.filter(c => c.status === 'success');
        if (validList.length === 0) { alert('ç„¡å¯ç”¨é »é“'); return; }
        let content = "#EXTM3U\n";
        validList.forEach(c => content += `#EXTINF:-1,${c.name}\n${c.url}\n`);
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'valid_channels.m3u';
        a.click();
        URL.revokeObjectURL(url);
    }

    function copyValidUrls() {
        const validList = channels.filter(c => c.status === 'success');
        if (validList.length === 0) { alert('ç„¡å¯ç”¨é »é“'); return; }
        let content = "";
        validList.forEach(c => content += `${c.name},${c.url}\n`);
        navigator.clipboard.writeText(content).then(() => alert(`å·²è¤‡è£½ ${validList.length} å€‹é »é“ï¼`));
    }

    function updateStats() {
        document.getElementById('totalCount').innerText = channels.length;
        document.getElementById('successCount').innerText = channels.filter(c => c.status === 'success').length;
        document.getElementById('failCount').innerText = channels.filter(c => c.status === 'fail').length;
    }

    function updateProgressBar(percent) {
        const bar = document.getElementById('progressBar');
        bar.style.width = percent + '%';
        bar.innerText = percent + '%';
        if(percent === 100) {
            bar.classList.remove('progress-bar-animated');
            bar.classList.add('bg-success');
        } else {
            bar.classList.add('progress-bar-animated');
            bar.classList.remove('bg-success');
        }
    }

    function clearAll() {
        processing = false;
        if (abortController) abortController.abort();
        document.getElementById('m3uInput').value = '';
        document.getElementById('remoteUrlInput').value = '';
        document.getElementById('fileInput').value = '';
        document.getElementById('resultBody').innerHTML = '<tr><td colspan="4" class="text-center py-5 text-muted">å·²æ¸…ç©º</td></tr>';
        document.getElementById('actionPanel').classList.add('d-none');
        channels = [];
        // é‡ç½®ç¯©é¸æŒ‰éˆ•
        isFiltered = false;
        document.getElementById('filterBtn').innerHTML = 'ğŸ‘ï¸ åªé¡¯ç¤ºå¯ç”¨é »é“';
        document.getElementById('filterBtn').classList.replace('btn-primary', 'btn-outline-primary');
    }

    function showLoading(show, text) {
        const el = document.getElementById('loadingOverlay');
        document.getElementById('loadingText').innerText = text || 'è™•ç†ä¸­...';
        show ? el.classList.remove('d-none') : el.classList.add('d-none');
    }

    let hls = null;
    function playChannel(index) {
        const channel = channels[index];
        const video = document.getElementById('videoPlayer');
        document.getElementById('modalTitle').innerText = `ğŸ“º ${channel.name}`;
        new bootstrap.Modal(document.getElementById('videoModal')).show();

        if (Hls.isSupported()) {
            if (hls) hls.destroy();
            hls = new Hls();
            hls.loadSource(channel.url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = channel.url;
            video.addEventListener('loadedmetadata', () => video.play());
        }
    }

    function stopVideo() {
        const video = document.getElementById('videoPlayer');
        video.pause();
        video.src = "";
        if (hls) { hls.destroy(); hls = null; }
    }
    document.getElementById('videoModal').addEventListener('hidden.bs.modal', stopVideo);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
