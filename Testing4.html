<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U8 ç›´æ’­æºæª¢æ¸¬å·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .status-badge { width: 80px; text-align: center; }
        .url-text { font-size: 0.85em; color: #666; max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; vertical-align: middle;}
        #videoModal .modal-body { padding: 0; background: black; }
        video { width: 100%; height: auto; display: block; }
    </style>
</head>
<body>

<div class="container mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <h2 class="text-center mb-4">ğŸ“º M3U8 ç›´æ’­æºæª¢æ¸¬èˆ‡æ’­æ”¾å·¥å…·</h2>

            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">1. è¼¸å…¥ M3U å…§å®¹ æˆ– ä¸Šå‚³æ–‡ä»¶</label>
                        <textarea id="m3uInput" class="form-control" rows="5" placeholder="#EXTM3U&#10;#EXTINF:-1,CCTV-1&#10;http://example.com/live.m3u8"></textarea>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <input type="file" id="fileInput" class="form-control" accept=".m3u,.m3u8,.txt">
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary px-4" onclick="processM3U()">ğŸš€ é–‹å§‹è§£æèˆ‡æª¢æ¸¬</button>
                            <button class="btn btn-secondary" onclick="clearAll()">æ¸…é™¤</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="statsBar" class="alert alert-info d-none d-flex justify-content-between align-items-center">
                <span>ç¸½æ•¸: <strong id="totalCount">0</strong></span>
                <span class="text-success">å¯ç”¨: <strong id="successCount">0</strong></span>
                <span class="text-danger">å¤±æ•—/CORS: <strong id="failCount">0</strong></span>
                <span>é€²åº¦: <span id="progressText">0%</span></span>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-white fw-bold">æª¢æ¸¬çµæœåˆ—è¡¨</div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>é »é“åç¨±</th>
                                    <th>é€£çµ / ç‹€æ…‹</th>
                                    <th style="width: 150px;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="resultBody">
                                <tr>
                                    <td colspan="4" class="text-center py-4 text-muted">è«‹è¼¸å…¥ç›´æ’­æºä¸¦æŒ‰ä¸‹é–‹å§‹æŒ‰éˆ•</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-truncate" id="modalTitle">æ’­æ”¾æ¸¬è©¦</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="stopVideo()"></button>
            </div>
            <div class="modal-body">
                <video id="videoPlayer" controls></video>
            </div>
        </div>
    </div>
</div>

<script>
    let channels = [];
    let processing = false;

    // è®€å–æ–‡ä»¶
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('m3uInput').value = e.target.result;
        };
        reader.readAsText(file);
    });

    function clearAll() {
        document.getElementById('m3uInput').value = '';
        document.getElementById('fileInput').value = '';
        document.getElementById('resultBody').innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">å·²æ¸…ç©º</td></tr>';
        document.getElementById('statsBar').classList.add('d-none');
        channels = [];
    }

    // è§£æ M3U å…§å®¹
    function processM3U() {
        if (processing) return;
        const content = document.getElementById('m3uInput').value;
        if (!content.trim()) {
            alert('è«‹è¼¸å…¥æˆ–ä¸Šå‚³ M3U å…§å®¹');
            return;
        }

        const lines = content.split('\n');
        channels = [];
        let currentName = "æœªå‘½åé »é“";
        
        // ç°¡å–®çš„è§£æé‚è¼¯
        for (let line of lines) {
            line = line.trim();
            if (line.startsWith('#EXTINF')) {
                // å˜—è©¦æå–é »é“åç¨± (é€—è™Ÿå¾Œé¢çš„éƒ¨åˆ†)
                const parts = line.split(',');
                currentName = parts.length > 1 ? parts[parts.length - 1].trim() : "æœªçŸ¥é »é“";
            } else if (line.startsWith('http') || (line.endsWith('.m3u8') && !line.startsWith('#'))) {
                channels.push({
                    id: channels.length,
                    name: currentName,
                    url: line,
                    status: 'pending' // pending, success, fail
                });
                // é‡ç½®åç¨±ï¼Œé˜²æ­¢ä¸‹ä¸€å€‹ç¶²å€æ²’æœ‰ EXTINF æ™‚æ²¿ç”¨èˆŠåç¨±
                currentName = "æœªå‘½åé »é“"; 
            }
        }

        if (channels.length === 0) {
            alert('æœªèƒ½è­˜åˆ¥å‡ºæœ‰æ•ˆçš„ç›´æ’­æºéˆæ¥ (http...)');
            return;
        }

        renderTable();
        startChecking();
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable() {
        const tbody = document.getElementById('resultBody');
        tbody.innerHTML = '';
        
        document.getElementById('statsBar').classList.remove('d-none');
        updateStats();

        channels.forEach((ch, index) => {
            const tr = document.createElement('tr');
            tr.id = `row-${index}`;
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td class="fw-bold text-primary">${ch.name}</td>
                <td>
                    <span id="badge-${index}" class="badge bg-secondary status-badge me-2">å¾…æª¢æ¸¬</span>
                    <span class="url-text" title="${ch.url}">${ch.url}</span>
                </td>
                <td>
                    <button class="btn btn-sm btn-success" onclick="playChannel(${index})">
                        â–¶ æ’­æ”¾
                    </button>
                    <a href="${ch.url}" target="_blank" class="btn btn-sm btn-outline-secondary">
                        ğŸ”— ç›´é€£
                    </a>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // æ›´æ–°çµ±è¨ˆæ•¸æ“š
    function updateStats() {
        document.getElementById('totalCount').innerText = channels.length;
        document.getElementById('successCount').innerText = channels.filter(c => c.status === 'success').length;
        document.getElementById('failCount').innerText = channels.filter(c => c.status === 'fail').length;
        
        const checked = channels.filter(c => c.status !== 'pending').length;
        const percent = Math.round((checked / channels.length) * 100);
        document.getElementById('progressText').innerText = percent + "%";
    }

    // æ‰¹é‡æª¢æ¸¬ (ä½¿ç”¨ fetch HEAD æ–¹æ³•)
    async function startChecking() {
        processing = true;
        // é™åˆ¶ä½µç™¼æ•¸ï¼Œä»¥å…ç€è¦½å™¨å¡æ­»ï¼Œé€™è£¡è¨­ç‚ºä¸€æ¬¡ 5 å€‹
        const batchSize = 5; 
        
        for (let i = 0; i < channels.length; i += batchSize) {
            const batch = channels.slice(i, i + batchSize);
            await Promise.all(batch.map(ch => checkUrl(ch)));
            updateStats();
        }
        processing = false;
        alert('æª¢æ¸¬å®Œæˆï¼æ³¨æ„ï¼šé¡¯ç¤ºç´…è‰²çš„é …ç›®å¯èƒ½åƒ…å› è·¨åŸŸ(CORS)é™åˆ¶ç„¡æ³•æª¢æ¸¬ï¼Œè«‹å˜—è©¦é»æ“Šã€Œæ’­æ”¾ã€ç¢ºèªã€‚');
    }

    // å–®å€‹ URL æª¢æ¸¬é‚è¼¯
    async function checkUrl(channel) {
        const badge = document.getElementById(`badge-${channel.id}`);
        badge.className = 'badge bg-warning text-dark status-badge me-2';
        badge.innerText = 'æª¢æ¸¬ä¸­...';

        try {
            // ä½¿ç”¨ fetch å˜—è©¦ç™¼é€ HEAD è«‹æ±‚
            // æ³¨æ„ï¼šå¤§å¤šæ•¸ç›´æ’­æµéƒ½æœ‰ CORS ä¿è­·ï¼Œé€™ä¸€æ­¥å¾ˆå®¹æ˜“å¤±æ•—
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // 5ç§’è¶…æ™‚

            const response = await fetch(channel.url, {
                method: 'GET', // éƒ¨åˆ†æœå‹™å™¨ä¸æ”¯æ´ HEADï¼Œæ”¹ç”¨ GET è®€å–å°‘é‡æ•¸æ“š
                signal: controller.signal,
                mode: 'cors' // å˜—è©¦è·¨åŸŸ
            });
            
            clearTimeout(timeoutId);

            if (response.ok) {
                channel.status = 'success';
                badge.className = 'badge bg-success status-badge me-2';
                badge.innerText = 'å¯ç”¨';
            } else {
                throw new Error('Status not OK');
            }
        } catch (error) {
            // å¤±æ•—æˆ– CORS éŒ¯èª¤
            channel.status = 'fail';
            badge.className = 'badge bg-danger status-badge me-2';
            badge.innerText = 'å¤±æ•—/CORS';
        }
    }

    // æ’­æ”¾åŠŸèƒ½
    let hls = null;
    function playChannel(index) {
        const channel = channels[index];
        const video = document.getElementById('videoPlayer');
        const modalTitle = document.getElementById('modalTitle');
        
        modalTitle.innerText = `æ’­æ”¾ä¸­: ${channel.name}`;
        
        // é¡¯ç¤º Modal
        const modal = new bootstrap.Modal(document.getElementById('videoModal'));
        modal.show();

        if (Hls.isSupported()) {
            if (hls) {
                hls.destroy();
            }
            hls = new Hls();
            hls.loadSource(channel.url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                video.play();
            });
            // è™•ç†æ’­æ”¾éŒ¯èª¤
            hls.on(Hls.Events.ERROR, function (event, data) {
                 if (data.fatal) {
                    console.error("æ’­æ”¾éŒ¯èª¤:", data);
                    // alert("æ’­æ”¾å¤±æ•—ï¼Œè©²æºå¯èƒ½ç„¡æ•ˆæˆ–ç„¡æ³•è·¨åŸŸæ’­æ”¾");
                 }
            });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            // Safari åŸç”Ÿæ”¯æ´
            video.src = channel.url;
            video.addEventListener('loadedmetadata', function() {
                video.play();
            });
        }
    }

    // é—œé–‰ Modal æ™‚åœæ­¢æ’­æ”¾
    function stopVideo() {
        const video = document.getElementById('videoPlayer');
        video.pause();
        video.src = "";
        if (hls) {
            hls.destroy();
            hls = null;
        }
    }

    // ç›£è½ Modal é—œé–‰äº‹ä»¶ (åŒ…æ‹¬é»æ“ŠèƒŒæ™¯é—œé–‰)
    document.getElementById('videoModal').addEventListener('hidden.bs.modal', function () {
        stopVideo();
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
