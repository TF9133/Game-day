<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›´æ’­æºæª¢æ¸¬å·¥å…· V3.2 (é˜²å´©æ½°ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; padding-bottom: 50px; }
        .status-badge { width: 90px; text-align: center; }
        .url-text { font-size: 0.8em; color: #888; max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; vertical-align: middle;}
        #videoModal .modal-body { padding: 0; background: black; }
        video { width: 100%; height: auto; display: block; max-height: 80vh; }
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .group-badge { font-size: 0.8em; max-width: 120px; display: inline-block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    </style>
</head>
<body>

<div id="loadingOverlay" class="loading-overlay d-none">
    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
    <h4 id="loadingText">è™•ç†ä¸­...</h4>
    <small class="text-muted mt-2">æ­£åœ¨éæ¿¾ç„¡æ•ˆä»£ç¢¼èˆ‡åƒåœ¾è³‡è¨Š...</small>
</div>

<div class="container mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <h2 class="text-center mb-4">ğŸ“º ç›´æ’­æºæª¢æ¸¬å·¥å…· <span class="badge bg-success fs-6">V3.2 é˜²å´©æ½°ç‰ˆ</span></h2>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">ğŸ“¥ ä¾†æºè¼¸å…¥</h5>
                </div>
                <div class="card-body">
                    <label class="form-label fw-bold">æ–¹å¼ Aï¼šå¾ç¶²å€è¼‰å…¥</label>
                    <div class="input-group mb-3">
                        <span class="input-group-text">ğŸ”— URL</span>
                        <input type="text" id="remoteUrlInput" class="form-control" placeholder="è¼¸å…¥ .m3u æˆ– .txt ç›´æ’­æºç¶²å€">
                        <button class="btn btn-info text-white" onclick="loadFromUrl()">â¬‡ï¸ è¼‰å…¥å…§å®¹</button>
                    </div>

                    <hr class="my-3">

                    <label class="form-label fw-bold">æ–¹å¼ Bï¼šè²¼ä¸Šå…§å®¹ æˆ– ä¸Šå‚³æ–‡ä»¶</label>
                    <textarea id="m3uInput" class="form-control mb-3" rows="6" placeholder="ç›´æ¥è²¼ä¸Šå…§å®¹ï¼Œç³»çµ±æœƒè‡ªå‹•éæ¿¾ç„¡æ•ˆä»£ç¢¼..."></textarea>
                    
                    <div class="row g-2">
                        <div class="col-md-5">
                            <input type="file" id="fileInput" class="form-control" accept=".m3u,.m3u8,.txt">
                        </div>
                        <div class="col-md-7 text-end">
                            <button class="btn btn-secondary me-1" onclick="clearAll()">ğŸ§¹ æ¸…é™¤é‡ç½®</button>
                            <button class="btn btn-primary px-4" onclick="processContent()">ğŸš€ è§£æä¸¦æª¢æ¸¬</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="actionPanel" class="d-none">
                <div class="card mb-3 border-secondary">
                    <div class="card-body d-flex justify-content-between align-items-center flex-wrap gap-2 py-2">
                        <div id="statsInfo" class="fs-6">
                            ç¸½æ•¸: <strong id="totalCount">0</strong> | 
                            <span class="text-success">å¯ç”¨: <strong id="successCount">0</strong></span> | 
                            <span class="text-danger">å¤±æ•—: <strong id="failCount">0</strong></span>
                        </div>
                        
                        <div class="btn-group">
                            <button class="btn btn-success btn-sm" onclick="downloadValidM3U()">ğŸ“¥ å°å‡º M3U</button>
                            <button class="btn btn-outline-dark btn-sm" onclick="copyValidUrls()">ğŸ“‹ è¤‡è£½æ¸…å–®</button>
                        </div>
                    </div>
                    <div class="progress" style="height: 5px; border-radius: 0;">
                        <div id="progressBar" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                    <span>æª¢æ¸¬çµæœåˆ—è¡¨</span>
                    <button id="filterBtn" class="btn btn-outline-primary btn-sm" onclick="toggleFilter()">
                        ğŸ‘ï¸ åªé¡¯ç¤ºå¯ç”¨é »é“
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th style="width: 120px;">åˆ†é¡</th>
                                    <th>é »é“åç¨±</th>
                                    <th>é€£çµ / ç‹€æ…‹</th>
                                    <th style="width: 150px;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="resultBody">
                                <tr>
                                    <td colspan="5" class="text-center py-5 text-muted">
                                        æº–å‚™å°±ç·’ï¼Œè«‹è¼‰å…¥ç›´æ’­æº
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-truncate" id="modalTitle">æ’­æ”¾æ¸¬è©¦</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="stopVideo()"></button>
            </div>
            <div class="modal-body">
                <video id="videoPlayer" controls autoplay></video>
            </div>
            <div class="modal-footer justify-content-between">
                <small class="text-muted" id="playerStatus">æº–å‚™æ’­æ”¾...</small>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal" onclick="stopVideo()">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>

<script>
    let channels = [];
    let processing = false;
    let abortController = null;
    let isFiltered = false; 

    // --- 1. è¼‰å…¥èˆ‡æ–‡ä»¶è™•ç† ---
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        showLoading(true, 'æ­£åœ¨è®€å–æ–‡ä»¶...');
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('m3uInput').value = e.target.result;
            showLoading(false);
            setTimeout(() => {
                if(confirm(`æ–‡ä»¶è®€å–æˆåŠŸï¼æ˜¯å¦ç«‹å³é–‹å§‹è§£æï¼Ÿ`)) processContent();
            }, 100);
        };
        reader.onerror = () => { showLoading(false); alert('è®€å–å¤±æ•—'); };
        reader.readAsText(file);
        this.value = null; 
    });

    async function loadFromUrl() {
        const url = document.getElementById('remoteUrlInput').value.trim();
        if (!url) { alert('è«‹è¼¸å…¥ç¶²å€'); return; }

        showLoading(true, 'ä¸‹è¼‰é ç«¯æ–‡ä»¶ä¸­...');
        try {
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}&t=${Date.now()}`;
            const response = await fetch(proxyUrl);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const text = await response.text();
            document.getElementById('m3uInput').value = text;
            showLoading(false);
            setTimeout(() => {
                if(confirm(`è¼‰å…¥æˆåŠŸï¼æ˜¯å¦é–‹å§‹è§£æï¼Ÿ`)) processContent();
            }, 200);
        } catch (error) {
            showLoading(false);
            alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        }
    }

    // --- 2. åš´æ ¼è§£ææ ¸å¿ƒ (éæ¿¾åƒåœ¾ä»£ç¢¼) ---
    
    // é©—è­‰æ˜¯å¦ç‚ºæœ‰æ•ˆçš„ http/rtmp é–‹é ­
    function isValidUrl(string) {
        try {
            const trimmed = string.trim();
            // å¿…é ˆä»¥ http, https, rtmp, rtsp é–‹é ­
            return /^(http|https|rtmp|rtsp):\/\//i.test(trimmed);
        } catch (_) {
            return false;
        }
    }

    function processContent() {
        if (processing) return;
        if (abortController) abortController.abort();
        abortController = new AbortController();
        
        isFiltered = false;
        resetFilterBtn();

        const content = document.getElementById('m3uInput').value;
        if (!content.trim()) { alert('è«‹è¼¸å…¥å…§å®¹'); return; }

        showLoading(true, 'æ­£åœ¨æ¸…æ´—æ•¸æ“šä¸¦è§£æ...');

        setTimeout(() => {
            channels = [];
            // æ ¹æ“šå…§å®¹ç‰¹å¾µé¸æ“‡è§£æå™¨
            if (content.includes('#EXTINF')) {
                parseM3U(content);
            } else {
                parseTXT(content);
            }

            if (channels.length === 0) {
                showLoading(false);
                alert('è§£æå¾Œæ²’æœ‰ç™¼ç¾æœ‰æ•ˆé€£çµã€‚\nç³»çµ±å·²è‡ªå‹•éæ¿¾æ‰éæ¨™æº–çš„ä»£ç¢¼ (å¦‚ plugin:// æˆ–ç„¡æ•ˆæ–‡å­—)ã€‚');
                return;
            }

            showLoading(false);
            document.getElementById('actionPanel').classList.remove('d-none');
            renderTable();
            startChecking();
        }, 100);
    }

    function parseM3U(content) {
        const lines = content.split('\n');
        let currentGroup = "æœªåˆ†é¡";
        let currentName = "æœªå‘½åé »é“";
        
        for (let line of lines) {
            line = line.trim();
            if (!line) continue;

            if (line.startsWith('#EXTINF')) {
                // è§£æ Group
                const groupMatch = line.match(/group-title="([^"]*)"/);
                if (groupMatch) {
                    currentGroup = groupMatch[1];
                } else {
                     const simpleMatch = line.match(/group-title=([^, ]+)/);
                     if(simpleMatch) currentGroup = simpleMatch[1];
                }
                // è§£æ Name
                const lastComma = line.lastIndexOf(',');
                currentName = lastComma !== -1 ? line.substring(lastComma + 1).trim() : "æœªçŸ¥é »é“";
            } 
            else if (line.indexOf('://') > 0 && !line.startsWith('#')) {
                // ã€é—œéµä¿®å¾©ã€‘: åœ¨åŠ å…¥åˆ—è¡¨å‰ï¼Œå…ˆæª¢æŸ¥å®ƒæ˜¯ä¸æ˜¯ä¸€å€‹ã€Œåƒæ¨£ã€çš„ç¶²å€
                if (isValidUrl(line)) {
                    channels.push({
                        id: channels.length,
                        group: currentGroup,
                        name: currentName,
                        url: line,
                        status: 'pending'
                    });
                } else {
                    console.warn("è·³éç„¡æ•ˆé€£çµè¡Œ:", line);
                }
                // M3U é‚è¼¯é€šå¸¸æ˜¯ä¸€åä¸€å€ï¼Œæ‰€ä»¥ç”¨å®Œåå­—å¾Œé‡ç½®ï¼Œé˜²æ­¢éŒ¯ä½
                currentName = "æœªå‘½åé »é“"; 
            }
        }
    }

    function parseTXT(content) {
        const lines = content.split('\n');
        let currentGroup = "é è¨­";

        for (let line of lines) {
            line = line.trim();
            if (!line) continue;

            if (line.includes('#genre#')) {
                currentGroup = line.replace(/,?#genre#/, '').trim();
                continue;
            }

            let separatorIndex = line.indexOf(',');
            if (separatorIndex === -1) separatorIndex = line.indexOf('ï¼Œ');

            if (separatorIndex !== -1) {
                const namePart = line.substring(0, separatorIndex).trim();
                const urlPart = line.substring(separatorIndex + 1).trim();

                // ã€é—œéµä¿®å¾©ã€‘: TXT æ¨¡å¼åŒæ¨£åš´æ ¼æª¢æŸ¥ URL
                if (isValidUrl(urlPart)) {
                    channels.push({
                        id: channels.length,
                        group: currentGroup,
                        name: namePart,
                        url: urlPart,
                        status: 'pending'
                    });
                }
            }
        }
    }

    // --- 3. ä»‹é¢æ¸²æŸ“ ---
    function renderTable() {
        const tbody = document.getElementById('resultBody');
        tbody.innerHTML = '';
        updateStats();

        // ç‚ºäº†æ€§èƒ½ï¼Œé€™è£¡é™åˆ¶é¡¯ç¤ºæˆ–è€…åˆ†æ‰¹ï¼Œç›®å‰å…ˆé¡¯ç¤ºå…¨éƒ¨
        // å¦‚æœåˆ—è¡¨éå¸¸å¤§ (è¶…é 5000)ï¼Œå»ºè­°åœ¨çœŸå¯¦ç”¢å“ä¸­ä½¿ç”¨è™›æ“¬æ»¾å‹•ï¼Œæ­¤è™•ä¿æŒç°¡å–®
        const fragment = document.createDocumentFragment();
        
        channels.forEach((ch, index) => {
            const tr = document.createElement('tr');
            tr.id = `row-${index}`;
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td><span class="badge bg-info text-dark group-badge" title="${ch.group}">${ch.group}</span></td>
                <td class="fw-bold text-primary text-truncate" style="max-width: 180px;" title="${ch.name}">${ch.name}</td>
                <td>
                    <span id="badge-${index}" class="badge bg-secondary status-badge me-1">å¾…æª¢æ¸¬</span>
                    <span class="url-text" title="${ch.url}">${ch.url}</span>
                </td>
                <td>
                    <button class="btn btn-sm btn-success py-0 px-2" onclick="playChannel(${index})">â–¶</button>
                    <a href="${ch.url}" target="_blank" class="btn btn-sm btn-outline-secondary py-0 px-2">ğŸ”—</a>
                </td>
            `;
            fragment.appendChild(tr);
        });
        tbody.appendChild(fragment);
    }

    // --- 4. ç©©å¥çš„æª¢æ¸¬æµç¨‹ (é˜²å´©æ½°) ---
    async function startChecking() {
        processing = true;
        const batchSize = 15; // ç¨å¾®åŠ å¤§ä½µç™¼
        let completed = 0;
        updateProgressBar(0);

        for (let i = 0; i < channels.length; i += batchSize) {
            if (!processing) break;
            const batch = channels.slice(i, i + batchSize);
            
            // ä½¿ç”¨ Promise.allSettled ä¹Ÿå¯ä»¥ï¼Œä½†é€™è£¡æˆ‘å€‘åœ¨ checkUrl å…§éƒ¨å·²ç¶“ catch äº†æ‰€æœ‰éŒ¯èª¤
            // æ‰€ä»¥ Promise.all æ˜¯å®‰å…¨çš„
            await Promise.all(batch.map(ch => checkUrl(ch)));
            
            completed += batch.length;
            updateStats();
            updateProgressBar(Math.round((completed / channels.length) * 100));

            if (isFiltered) {
                batch.forEach(ch => {
                    const row = document.getElementById(`row-${ch.id}`);
                    if(row && ch.status !== 'success') row.style.display = 'none';
                });
            }
        }
        processing = false;
    }

    async function checkUrl(channel) {
        const badge = document.getElementById(`badge-${channel.id}`);
        if(!badge) return;

        badge.className = 'badge bg-warning text-dark status-badge me-1';
        badge.innerText = '...';

        try {
            // ã€é—œéµä¿®å¾©ã€‘: é›™é‡ä¿éšªï¼Œç¢ºä¿ URL å»ºæ§‹ä¸æœƒå ±éŒ¯
            try {
                new URL(channel.url); 
            } catch (e) {
                throw new Error("URL æ ¼å¼éŒ¯èª¤");
            }

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000); 
            
            const response = await fetch(channel.url, {
                method: 'GET',
                signal: controller.signal,
                referrerPolicy: 'no-referrer'
            });
            clearTimeout(timeoutId);

            if (response.ok) {
                channel.status = 'success';
                badge.className = 'badge bg-success status-badge me-1';
                badge.innerText = 'å¯ç”¨';
            } else {
                throw new Error(response.status);
            }
        } catch (error) {
            // é€™è£¡æ•æ‰æ‰€æœ‰çš„ç¶²è·¯éŒ¯èª¤ã€è¶…æ™‚ã€æ ¼å¼éŒ¯èª¤
            // ç¢ºä¿ä¸æœƒè®“å¤–éƒ¨ Loop å´©æ½°
            channel.status = 'fail';
            badge.className = 'badge bg-danger status-badge me-1';
            
            // å¦‚æœæ˜¯åš´é‡æ ¼å¼éŒ¯èª¤ï¼Œé¡¯ç¤ºä¸åŒæ–‡å­—
            if (error.message === "URL æ ¼å¼éŒ¯èª¤") {
                badge.innerText = 'æ ¼å¼éŒ¯';
            } else {
                badge.innerText = 'å¤±æ•—';
            }
        }
    }

    // --- 5. å…¶ä»–åŠŸèƒ½ ---
    let hls = null;
    function playChannel(index) {
        const channel = channels[index];
        const video = document.getElementById('videoPlayer');
        const statusText = document.getElementById('playerStatus');
        document.getElementById('modalTitle').innerText = `ğŸ“º ${channel.name}`;
        statusText.innerText = "å˜—è©¦è¼‰å…¥ä¸­...";
        new bootstrap.Modal(document.getElementById('videoModal')).show();

        const isM3u8 = channel.url.includes('.m3u8');
        if (hls) { hls.destroy(); hls = null; }

        if (isM3u8 && Hls.isSupported()) {
            hls = new Hls();
            hls.loadSource(channel.url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                video.play().catch(e => console.log(e));
                statusText.innerText = "æ­£åœ¨æ’­æ”¾ (HLS æ¨¡å¼)";
            });
            hls.on(Hls.Events.ERROR, (e, data) => {
                if(data.fatal) statusText.innerText = "HLS éŒ¯èª¤: " + data.type;
            });
        } else {
            video.src = channel.url;
            video.play().then(() => statusText.innerText = "æ­£åœ¨æ’­æ”¾ (åŸç”Ÿæ¨¡å¼)")
                .catch(e => statusText.innerText = "æ’­æ”¾å¤±æ•— (å¯èƒ½éœ€è·¨åŸŸ)");
        }
    }
    
    function stopVideo() {
        const video = document.getElementById('videoPlayer');
        video.pause();
        video.src = "";
        if (hls) { hls.destroy(); hls = null; }
    }
    document.getElementById('videoModal').addEventListener('hidden.bs.modal', stopVideo);

    function toggleFilter() {
        const btn = document.getElementById('filterBtn');
        isFiltered = !isFiltered;
        if (isFiltered) {
            btn.innerHTML = 'ğŸ“‹ é¡¯ç¤ºå…¨éƒ¨é »é“';
            btn.classList.replace('btn-outline-primary', 'btn-primary');
            channels.forEach((ch, index) => {
                const row = document.getElementById(`row-${index}`);
                if (row) row.style.display = (ch.status === 'success') ? '' : 'none';
            });
        } else {
            resetFilterBtn();
            const rows = document.querySelectorAll('#resultBody tr');
            rows.forEach(row => row.style.display = '');
        }
    }

    function resetFilterBtn() {
        document.getElementById('filterBtn').innerHTML = 'ğŸ‘ï¸ åªé¡¯ç¤ºå¯ç”¨é »é“';
        document.getElementById('filterBtn').classList.replace('btn-primary', 'btn-outline-primary');
    }

    function downloadValidM3U() {
        const validList = channels.filter(c => c.status === 'success');
        if (validList.length === 0) { alert('ç„¡å¯ç”¨é »é“'); return; }
        let content = "#EXTM3U\n";
        validList.forEach(c => content += `#EXTINF:-1 group-title="${c.group}",${c.name}\n${c.url}\n`);
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `iptv_checked_${validList.length}.m3u`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function copyValidUrls() {
        const validList = channels.filter(c => c.status === 'success');
        if (validList.length === 0) { alert('ç„¡å¯ç”¨é »é“'); return; }
        let content = "";
        validList.forEach(c => content += `${c.name},${c.url}\n`);
        navigator.clipboard.writeText(content).then(() => alert(`å·²è¤‡è£½ ${validList.length} æ¢é€£çµ`));
    }

    function updateStats() {
        document.getElementById('totalCount').innerText = channels.length;
        document.getElementById('successCount').innerText = channels.filter(c => c.status === 'success').length;
        document.getElementById('failCount').innerText = channels.filter(c => c.status === 'fail').length;
    }

    function updateProgressBar(percent) {
        document.getElementById('progressBar').style.width = percent + '%';
    }

    function showLoading(show, text) {
        const el = document.getElementById('loadingOverlay');
        document.getElementById('loadingText').innerText = text || 'è™•ç†ä¸­...';
        show ? el.classList.remove('d-none') : el.classList.add('d-none');
    }

    function clearAll() {
        processing = false;
        if (abortController) abortController.abort();
        document.getElementById('m3uInput').value = '';
        document.getElementById('remoteUrlInput').value = '';
        document.getElementById('fileInput').value = '';
        document.getElementById('resultBody').innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted">å·²æ¸…ç©º</td></tr>';
        document.getElementById('actionPanel').classList.add('d-none');
        channels = [];
        resetFilterBtn();
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
